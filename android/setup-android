#!/usr/bin/env bash

# This script sets up symbolic links to the Cinder source tree for use by the
# Android ndk-build script.  On Windows (cygwin) it requires the Junction
# tool [1] to be installed and available in the PATH.
#
# It will also download and set up FreeImage for building on Android.  This
# requires curl, unzip, tar and bzip2 to be in the PATH.
#
#
# [1] http://technet.microsoft.com/en-us/sysinternals/bb896768

function remove_old_links {
    rm -f jni/cinder
}

function check_for_junction {
    hash junction 2>&-
    if [ $? -ne 0 ]; then
        echo "Error: this script requires junction.exe in your PATH variable."
        echo "  Verify your installation and try again"
        echo "  (http://technet.microsoft.com/en-us/sysinternals/bb896768)"
        exit
    fi
}

function unpack_freeimage {
    if [ ! -e setup/FreeImage/FreeImage3150.zip ]; then
        echo "Downloading FreeImage source distribution..."
        curl -O http://expandingbrain.com/cinder/FreeImage3150.zip
        mv FreeImage3150.zip setup/FreeImage
    fi
    echo "Setup FreeImage..."
    rm -rf jni/FreeImage
    unzip setup/FreeImage/FreeImage3150.zip -d jni
    cp -p setup/FreeImage/Android.mk jni/FreeImage
	# patched source files with missing function implementations
    cp -pf setup/FreeImage/dcraw_common.cpp jni/FreeImage/Source/LibRawLite/internal/dcraw_common.cpp
    cp -pf setup/FreeImage/tif_dirinfo.c jni/FreeImage/Source/LibTIFF/tif_dirinfo.c
}

function unpack_freetype {
    if [ ! -e setup/freetype/freetype-2.4.5.tar.bz2 ]; then
        echo "Downloading freetype source distribution"
        curl -L -O http://download.savannah.gnu.org/releases/freetype/freetype-2.4.5.tar.bz2
        mv freetype-2.4.5.tar.bz2 setup/freetype
    fi
    echo "Setup freetype..."
    rm -rf jni/freetype-2.4.5
    tar jxvf setup/freetype/freetype-2.4.5.tar.bz2 -C jni
    cp -p setup/freetype/Android.mk jni/freetype-2.4.5
	cp -pf setup/freetype/ftmodule.h jni/freetype-2.4.5/include/freetype/config/ftmodule.h
}

if [ $OSTYPE = "cygwin" ]; then
    check_for_junction
    remove_old_links
    mkdir -p jni/cinder
    junction jni\\cinder\\boost ..\\boost && junction jni\\cinder\\include ..\\include && junction jni\\cinder\\src ..\\src
else
    remove_old_links
    ln -s $PWD/../boost jni/cinder/boost && ln -s $PWD/../include jni/cinder/include && ln -s $PWD/../src jni/cinder/src
fi

unpack_freeimage
unpack_freetype

cp -pf setup/Configure.mk jni/cinder/Configure.mk
cp -pf setup/Cinder.mk jni/cinder/Android.mk

echo
if [ $? -ne 0 ]; then
    echo "Error creating Android tree, check your Cinder source layout."
else
    echo "Android source tree created, ready to run ndk-build"
    echo
    echo "(Optional) Edit jni/Configure.mk to select build settings"
fi

